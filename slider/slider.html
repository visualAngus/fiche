<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agenda</title>
    <link rel="stylesheet" href="./css/style_agenda.css">

</head>

<body>
    <button id="btn_add_event" onclick="show_modif_for_add()">Ajouter un événement</button>
    <div class="div_all_main_agenda">

        <div class="div_agenda_viewer">
            <div class="div_main_jours">
                <div class="jour">
                    <h2></h2>
                    <h3></h3>
                </div>
                <div class="jour">
                    <h2>Lun.</h2>
                    <h3>11</h3>
                </div>
                <div class="jour">
                    <h2>Mar.</h2>
                    <h3>12</h3>
                </div>
                <div class="jour">
                    <h2>Mer.</h2>
                    <h3>13</h3>
                </div>
                <div class="jour">
                    <h2>Jeu.</h2>
                    <h3>14</h3>
                </div>
                <div class="jour">
                    <h2>Ven.</h2>
                    <h3>15</h3>
                </div>
                <div class="jour">
                    <h2>Sam.</h2>
                    <h3>16</h3>
                </div>
                <div class="jour">
                    <h2>Dim.</h2>
                    <h3>17</h3>
                </div>
            </div>
            <div class="div_main_agenda">
                <div class="heure">
                    <h2>00:00</h2>
                    <h2>01:00</h2>
                    <h2>02:00</h2>
                    <h2>03:00</h2>
                    <h2>04:00</h2>
                    <h2>05:00</h2>
                    <h2>06:00</h2>
                    <h2>07:00</h2>
                    <h2>08:00</h2>
                    <h2>09:00</h2>
                    <h2>10:00</h2>
                    <h2>11:00</h2>
                    <h2>12:00</h2>
                    <h2>13:00</h2>
                    <h2>14:00</h2>
                    <h2>15:00</h2>
                    <h2>16:00</h2>
                    <h2>17:00</h2>
                    <h2>18:00</h2>
                    <h2>19:00</h2>
                    <h2>20:00</h2>
                    <h2>21:00</h2>
                    <h2>22:00</h2>
                    <h2>23:00</h2>
                </div>
                <div class="day" id="lundi">
                    <div class="div_bg"></div>
                </div>
                <div class="day" id="mardi">
                    <div class="div_bg"></div>

                </div>
                <div class="day" id="mercredi">
                    <div class="div_bg"></div>

                </div>
                <div class="day" id="jeudi">
                    <div class="div_bg"></div>

                </div>
                <div class="day" id="vendredi">
                    <div class="div_bg"></div>

                </div>
                <div class="day" id="samedi">
                    <div class="div_bg"></div>

                </div>
                <div class="day" id="dimanche">
                    <div class="div_bg"></div>

                </div>
            </div>
        </div>
    </div>


</body>
<script>

    function show_modif(nom,description,date,heure_debut,heure_fin,color,event) {
        if(document.querySelector('.div_modif_event')){
            document.querySelector('.div_modif_event').remove();
        }
        console.log(date);

        let div_modif_event = document.createElement('div');
        div_modif_event.classList.add('div_modif_event');

        let titre_div = document.createElement('div');
        titre_div.classList.add('titre_div');
        let h2_modif = document.createElement('h2');
        h2_modif.id = 'modif';
        h2_modif.innerText = "Modifier l'événement";
        titre_div.appendChild(h2_modif);
        div_modif_event.appendChild(titre_div);

        let div_modif_main = document.createElement('div');
        div_modif_main.classList.add('div_modif_main');

        let div_left = document.createElement('div');
        div_left.classList.add('div_left');
        let div_event_name = document.createElement('div');
        div_event_name.classList.add('div_event_name');
        let h3_event_name = document.createElement('h3');
        h3_event_name.contentEditable = "true";
        h3_event_name.innerText = nom;
        div_event_name.appendChild(h3_event_name);
        div_left.appendChild(div_event_name);

        let div_event_description = document.createElement('div');
        div_event_description.classList.add('div_event_description');
        let h5_event_description = document.createElement('h5');
        h5_event_description.contentEditable = "true";
        h5_event_description.innerText = description;
        div_event_description.appendChild(h5_event_description);
        div_left.appendChild(div_event_description);

        div_modif_main.appendChild(div_left);

        let div_right = document.createElement('div');
        div_right.classList.add('div_right');

        let div_date = document.createElement('div');
        div_date.classList.add('div_date');
        let h3_date = document.createElement('h3');
        h3_date.innerText = "Date";
        let input_date = document.createElement('input');
        input_date.type = 'date';
        input_date.name = 'date';
        input_date.id = 'date';

        input_date.value = date.toISOString().split('T')[0];

        div_date.appendChild(h3_date);
        div_date.appendChild(input_date);
        div_right.appendChild(div_date);

        let div_heure_debut = document.createElement('div');
        div_heure_debut.classList.add('div_heure_debut');
        let h3_heure = document.createElement('h3');
        h3_heure.innerText = "Heure";
        let input_heure_debut = document.createElement('input');
        input_heure_debut.type = 'time';
        input_heure_debut.name = 'heure_debut';
        input_heure_debut.id = 'heure_debut';
        input_heure_debut.value = heure_debut;
        let h5_separator = document.createElement('h5');
        h5_separator.innerText = "-";
        let input_heure_fin = document.createElement('input');
        input_heure_fin.type = 'time';
        input_heure_fin.name = 'heure_fin';
        input_heure_fin.id = 'heure_fin';
        input_heure_fin.value = heure_fin;
        div_heure_debut.appendChild(h3_heure);
        div_heure_debut.appendChild(input_heure_debut);
        div_heure_debut.appendChild(h5_separator);
        div_heure_debut.appendChild(input_heure_fin);
        div_right.appendChild(div_heure_debut);

        let div_color = document.createElement('div');
        div_color.classList.add('div_color');
        let h3_color = document.createElement('h3');
        h3_color.innerText = "Couleur";
        let input_color = document.createElement('input');
        input_color.type = 'color';
        input_color.name = 'color';
        input_color.id = 'color';
        input_color.value = color;
        div_color.appendChild(h3_color);
        div_color.appendChild(input_color);
        div_right.appendChild(div_color);

        let div_btn = document.createElement('div');
        div_btn.classList.add('div_btn');
        let btn_save = document.createElement('button');
        btn_save.id = 'btn_save';
        btn_save.innerText = "Save";
        let btn_cancel = document.createElement('button');
        btn_cancel.id = 'btn_cancel';
        btn_cancel.innerText = "Cancel";
        div_btn.appendChild(btn_save);
        div_btn.appendChild(btn_cancel);
        div_right.appendChild(div_btn);

        div_modif_main.appendChild(div_right);
        div_modif_event.appendChild(div_modif_main);

        document.body.appendChild(div_modif_event);

        btn_save.addEventListener('click',function(){
            let nom = h3_event_name.innerText;
            let description = h5_event_description.innerText;
            let date = input_date.value;
            let heure_debut = input_heure_debut.value;
            let heure_fin = input_heure_fin.value;
            let color = input_color.value;

            event.querySelector('h3').innerText = nom;
            event.querySelector('p').innerText = description;
            event.setAttribute('time',new Date(date).getTime());
            event.setAttribute('heure_debut',heure_debut);
            event.setAttribute('heure_fin',heure_fin);
            event.style.backgroundColor = color;
            event.setAttribute('color',color);

            let heure_debut_split = parseInt(heure_debut.split(':')[0]) + 1;
            let heure_fin_split = parseInt(heure_fin.split(':')[0]) + 1;

            event.style.gridRow = `${heure_debut_split}/${heure_fin_split}`;

            div_modif_event.style.animation = 'hide_modif .4s cubic-bezier(0.68, -0.55, 0.27, 1) forwards';
            setTimeout(() => {
                div_modif_event.remove();
            }, 400);
        });

        btn_cancel.addEventListener('click',function(){
            div_modif_event.style.animation = 'hide_modif .4s cubic-bezier(0.68, -0.55, 0.27, 1) forwards';
            setTimeout(() => {
                div_modif_event.remove();
            }, 400);
        });
    }
    
    function show_modif_panel(event) {
        if (event.querySelector('.control_pannel')) {
            return;
        }
        let id = event.id;
        console.log(id);
        let div_main = document.createElement('div');
        div_main.classList.add('control_pannel');

        let edit = document.createElement('button');
        edit.classList.add('edit');
        edit.innerHTML = 'Edit';
        div_main.appendChild(edit);

        let del = document.createElement('button');
        del.classList.add('delete');
        del.innerHTML = 'Delete';
        div_main.appendChild(del);

        del.addEventListener('click', function (e) {
            delete_event_data_base(id);
        });

        event.appendChild(div_main);
        edit.addEventListener('click', function (e) {
            modif_event(event);
        });
    }

    function hide_modif_panel(event) {
        if (event.querySelector('.control_pannel')) {
            let div_main = event.querySelector('.control_pannel');
            div_main.style.animation = 'hide_anni .4s cubic-bezier(0.68, -0.55, 0.27, 1)';
            setTimeout(() => {
                div_main.remove();
            }, 400);
        }
    }

    function modif_event(event) {
        let id = event.id;
        let time = event.getAttribute('time');
        //convert time to date
        let date = new Date(parseInt(time));
        let heure_debut = event.getAttribute('heure_debut');
        let heure_fin = event.getAttribute('heure_fin');
        let color = event.getAttribute('color');

        let nom = event.querySelector('h3').innerText;
        let description = event.querySelector('p').innerText;

        show_modif(nom, description, date, heure_debut, heure_fin, color, event);
    }

    function addEvent(nom, description, date, heure_debut, heure_fin, id, id_groupe, color) {
        //get le jour en fonction de la date
        const jours = ['dimanche', 'lundi', 'mardi', 'mercredi', 'jeudi', 'vendredi', 'samedi'];
        let jour = new Date(date);

        let real_jour = jour.getTime();

        let jour_index = jour.getDay();
        let jour_fr = jours[jour_index];

        //get l'heure de debut et de fin
        let heure_debut_split = parseInt(heure_debut.split(':')[0]) + 1;
        let heure_fin_split = parseInt(heure_fin.split(':')[0]) + 1;


        let event = document.createElement('div');
        event.classList.add('event');
        event.classList.add('multi');
        event.id = id;
        event.setAttribute('time', real_jour);
        event.setAttribute('heure_debut', heure_debut);
        event.setAttribute('heure_fin', heure_fin);
        event.setAttribute('color', color);
        event.setAttribute('id_groupe', id_groupe);
        event.style.backgroundColor = color;
        event.style.gridRow = `${heure_debut_split}/${heure_fin_split}`;
        event.innerHTML = `<h3>${nom}</h3><p>${description}</p>`;

        document.querySelector('#' + jour_fr).appendChild(event);
        event.style.animation = 'show_anni .6s cubic-bezier(0.68, -0.55, 0.27, 1.55)';
    }

    document.addEventListener('mouseover', function (e) {
        if (e.target.closest('.event')) {
            let over_event = e.target.closest('.event');
            show_modif_panel(over_event);
        }else{
            let over_event = document.querySelectorAll('.event');
            over_event.forEach(event => {
                if (event.querySelector('.control_pannel')) {
                    hide_modif_panel(event);
                }
            });
        }
    });


    //si la touche alt est appuyé et que l'utilisateur scroll
    let AltIsDown = false;
    let startX;
    let scrollLeft;
    let pourcentage = 100;
    //detection de la touche alt
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Shift') {
            AltIsDown = true;
        }else{
            AltIsDown = false;
        }
    });

    document.addEventListener('keyup', (e) => {
        AltIsDown = false;
    });

    //gestion du scroll
    document.addEventListener('mousewheel', (e) => {
        if (AltIsDown) {
            let days = document.querySelectorAll('.day');
            let hours = document.querySelector('.heure');
            pourcentage += e.deltaY / -10;
            if (pourcentage > 300) {
                pourcentage = 300;
            } else if (pourcentage < 100) {
                pourcentage = 100;
            }

            days.forEach(day => {
                console.log(pourcentage);
                day.style.height = pourcentage + '%';
            });
            hours.style.height = pourcentage + '%';
        }
    });


    function show_modif_for_add(nom="nom",description="description",date,heure_debut,heure_fin,color) {
        if(document.querySelector('.div_modif_event')){
            document.querySelector('.div_modif_event').remove();
        }
        console.log(date);

        let div_modif_event = document.createElement('div');
        div_modif_event.classList.add('div_modif_event');

        let titre_div = document.createElement('div');
        titre_div.classList.add('titre_div');
        let h2_modif = document.createElement('h2');
        h2_modif.id = 'modif';
        h2_modif.innerText = "Modifier l'événement";
        titre_div.appendChild(h2_modif);
        div_modif_event.appendChild(titre_div);

        let div_modif_main = document.createElement('div');
        div_modif_main.classList.add('div_modif_main');

        let div_left = document.createElement('div');
        div_left.classList.add('div_left');
        let div_event_name = document.createElement('div');
        div_event_name.classList.add('div_event_name');
        let h3_event_name = document.createElement('h3');
        h3_event_name.contentEditable = "true";
        h3_event_name.innerText = nom;
        div_event_name.appendChild(h3_event_name);
        div_left.appendChild(div_event_name);

        let div_event_description = document.createElement('div');
        div_event_description.classList.add('div_event_description');
        let h5_event_description = document.createElement('h5');
        h5_event_description.contentEditable = "true";
        h5_event_description.innerText = description;
        div_event_description.appendChild(h5_event_description);
        div_left.appendChild(div_event_description);

        div_modif_main.appendChild(div_left);

        let div_right = document.createElement('div');
        div_right.classList.add('div_right');

        let div_date = document.createElement('div');
        div_date.classList.add('div_date');
        let h3_date = document.createElement('h3');
        h3_date.innerText = "Date";
        let input_date = document.createElement('input');
        input_date.type = 'date';
        input_date.name = 'date';
        input_date.id = 'date';

        // input_date.value = date.toISOString().split('T')[0];

        div_date.appendChild(h3_date);
        div_date.appendChild(input_date);
        div_right.appendChild(div_date);

        let div_heure_debut = document.createElement('div');
        div_heure_debut.classList.add('div_heure_debut');
        let h3_heure = document.createElement('h3');
        h3_heure.innerText = "Heure";
        let input_heure_debut = document.createElement('input');
        input_heure_debut.type = 'time';
        input_heure_debut.name = 'heure_debut';
        input_heure_debut.id = 'heure_debut';
        input_heure_debut.value = heure_debut;
        let h5_separator = document.createElement('h5');
        h5_separator.innerText = "-";
        let input_heure_fin = document.createElement('input');
        input_heure_fin.type = 'time';
        input_heure_fin.name = 'heure_fin';
        input_heure_fin.id = 'heure_fin';
        input_heure_fin.value = heure_fin;
        div_heure_debut.appendChild(h3_heure);
        div_heure_debut.appendChild(input_heure_debut);
        div_heure_debut.appendChild(h5_separator);
        div_heure_debut.appendChild(input_heure_fin);
        div_right.appendChild(div_heure_debut);

        let div_color = document.createElement('div');
        div_color.classList.add('div_color');
        let h3_color = document.createElement('h3');
        h3_color.innerText = "Couleur";
        let input_color = document.createElement('input');
        input_color.type = 'color';
        input_color.name = 'color';
        input_color.id = 'color';
        input_color.value = color;
        div_color.appendChild(h3_color);
        div_color.appendChild(input_color);
        div_right.appendChild(div_color);

        let div_btn = document.createElement('div');
        div_btn.classList.add('div_btn');
        let btn_save = document.createElement('button');
        btn_save.id = 'btn_save';
        btn_save.innerText = "Save";
        let btn_cancel = document.createElement('button');
        btn_cancel.id = 'btn_cancel';
        btn_cancel.innerText = "Cancel";
        div_btn.appendChild(btn_save);
        div_btn.appendChild(btn_cancel);
        div_right.appendChild(div_btn);

        div_modif_main.appendChild(div_right);
        div_modif_event.appendChild(div_modif_main);

        document.body.appendChild(div_modif_event);

        btn_save.addEventListener('click',function(){
            if (h3_event_name.innerText == "" || h5_event_description.innerText == "" || input_date.value == "" || input_heure_debut.value == "" || input_heure_fin.value == "") {
                return;
            }

            insert_event_data_base(h3_event_name.innerText,h5_event_description.innerText,input_date.value,input_heure_debut.value,input_heure_fin.value,1,input_color.value);
            div_modif_event.style.animation = 'hide_modif .4s cubic-bezier(0.68, -0.55, 0.27, 1) forwards';
            setTimeout(() => {
                div_modif_event.remove();
            }, 400);
        });

        btn_cancel.addEventListener('click',function(){
            div_modif_event.style.animation = 'hide_modif .4s cubic-bezier(0.68, -0.55, 0.27, 1) forwards';
            setTimeout(() => {
                div_modif_event.remove();
            }, 400);
        });
    }
    

    function insert_event_data_base(nom, description, date, heure_debut, heure_fin, id_groupe, color) {
        fetch('/createEvent', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                titre: nom,
                description: description,
                date: date,
                heure_debut: heure_debut,
                heure_fin: heure_fin,
                id_groupe: id_groupe,
                color: color
            })
        }).then(response => {
            return response.json();
        }).then(data => {
            console.log(data);
        });
    }

    function delete_event_data_base(id) {
        fetch('/deleteEvent', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                event_id: id
            })
        }).then(response => {
            return response.json();
        }).then(data => {
            console.log(data);
            document.getElementById(id).remove();
        });
    }


    function getAllEvents() {
        fetch('/getAllEvents', {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json'
            }
        }).then(response => {
            return response.json();
        }).then(data => {
            if (data.success) {
                data.data.forEach(event => {
                    event.events.forEach(e => {
                        console.log(e);
                        addEvent(e.nom, e.description, e.date, e.start_hour, e.end_hour, e.event_id, e.id_groupe_link, e.color);
                    });
                });
            }
        });
    }
    getAllEvents()
</script>

</html>